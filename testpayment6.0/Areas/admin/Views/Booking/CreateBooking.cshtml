@using testpayment6._0.Areas.admin.Models
@model BookingViewModel
@{
    ViewData["Title"] = "Đặt bàn cho khách hàng ";
    Layout = "~/Areas/admin/Views/Shared/_Layout.cshtml";
}

	@* @if (TempData["Error"] != null)
	{
		<div class="alert alert-danger">
			@TempData["Error"]
		</div>
	} *@
<form asp-action="CreateBooking" method="post" id="bookingForm">
    @Html.AntiForgeryToken()

    <!-- Thông tin khách hàng -->
    <div class="form-group">
        <label for="CustomerName">Tên khách hàng:</label>
        <input name="CustomerName" id="CustomerName"
               value="@Model?.CustomerName"
               class="form-control" required />
    </div>

    <div class="form-group">
        <label for="PhoneNumber">Số điện thoại:</label>
        <input name="PhoneNumber" id="PhoneNumber"
               value="@Model?.PhoneNumber"
               class="form-control" type="tel" required />
    </div>

    <div class="form-group">
        <label for="startingTime">Thời gian đặt bàn:</label>
        <input id="startingTime" name="startingTime" type="datetime-local" class="form-control" required />
    </div>

    <!-- Chọn khu vực -->
    <div class="form-group">
        <label for="regionSelect">Chọn khu vực:</label>
        <select id="regionSelect" class="form-control">
            <option value="">-- Chọn khu vực --</option>
            @if (Model.Regions != null)
            {
                @foreach (var region in Model.Regions)
                {
                    <option value="@region.regionId">@region.regionName</option>
                }
            }
        </select>
    </div>

    <!-- Container để hiển thị bàn theo khu vực -->
    <div class="form-group">
        <label>Chọn bàn:</label>
        <div id="tablesContainer">
            <!-- Bàn sẽ được load bằng AJAX -->
        </div>
    </div>

    <!-- Container để hiển thị món ăn theo khu vực -->
    <div class="form-group">
        <label>Chọn món ăn:</label>
        <div id="menuContainer">
            <!-- Món ăn sẽ được load bằng AJAX -->
        </div>
    </div>

    <!-- Hidden container để chứa các input hidden cho SelectedDishes -->
    <div id="selectedDishesContainer" style="display: none;">
        <!-- Các input hidden sẽ được tạo động ở đây -->
    </div>

    <button type="submit" class="btn btn-primary">Đặt bàn</button>
</form>

<!-- Thêm jQuery và script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var currentDishes = []; // Lưu trữ danh sách món ăn hiện tại

    $(document).ready(function() {
        // Khi chọn khu vực
        $('#regionSelect').change(function() {
            var regionId = $(this).val();

            if (regionId) {
                // Load bàn theo khu vực
                loadTablesByRegion(regionId);
                // Load món ăn theo khu vực
                loadMenuByRegion(regionId);
            } else {
                // Clear bàn và món ăn nếu không chọn khu vực
                $('#tablesContainer').empty();
                $('#menuContainer').empty();
                $('#selectedDishesContainer').empty();
                currentDishes = [];
            }
        });

        // Xử lý submit form
        $('#bookingForm').submit(function(e) {
            // Cập nhật selectedDishesContainer trước khi submit
            updateSelectedDishesContainer();

            // Kiểm tra xem có bàn nào được chọn không
            var selectedTables = $('input[name="SelectedTableIds"]:checked');
            if (selectedTables.length === 0) {
                alert('Vui lòng chọn ít nhất một bàn!');
                e.preventDefault();
                return false;
            }

            console.log('Form is being submitted...');
            return true;
        });
    });

    function loadTablesByRegion(regionId) {
        $.ajax({
            url: '/admin/Booking/GetTablesByRegion',
            type: 'GET',
            data: { regionId: regionId },
            success: function(response) {
                console.log('Tables response:', response);

                if (response.success && response.data) {
                    var tablesHtml = '';
                    $.each(response.data, function(index, table) {
                        tablesHtml += `
                            <div class="table-item" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <input type="checkbox" name="SelectedTableIds" value="${table.tableId}" id="table_${table.tableId}" />
                                <label for="table_${table.tableId}" style="margin-left: 10px; font-weight: bold;">
                                    Bàn ${table.tableId} (${table.capacity} chỗ)
                                </label>
                            </div>
                        `;
                    });
                    $('#tablesContainer').html(tablesHtml);
                } else {
                    $('#tablesContainer').html('<p>Không có bàn nào trong khu vực này</p>');
                    console.error('Error:', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error loading tables:', error);
                $('#tablesContainer').html('<p>Lỗi khi tải danh sách bàn</p>');
            }
        });
    }

    function loadMenuByRegion(regionId) {
        $.ajax({
            url: '/admin/Booking/GetMenuByRegion',
            type: 'GET',
            data: { regionId: regionId },
            success: function(response) {
                console.log('Menu response:', response);

                if (response.success && response.data) {
                    currentDishes = response.data; // Lưu trữ danh sách món ăn
                    var menuHtml = '';
                    $.each(response.data, function(index, dish) {
                        menuHtml += `
                            <div class="dish-item" style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <div class="dish-info">
                                    <div class="dish-name" style="font-weight: bold; font-size: 16px;">${dish.dishName}</div>
                                    <div class="dish-price" style="color: #e74c3c; font-weight: bold;">${dish.price.toLocaleString('vi-VN')} VNĐ</div>
                                </div>
                                <div class="quantity-control" style="display: flex; align-items: center;">
                                    <button type="button" class="btn-decrease" onclick="decreaseQuantity(${index})" style="background: #dc3545; color: white; border: none; width: 30px; height: 30px; border-radius: 5px; margin-right: 10px;">-</button>
                                    <input type="number" id="quantity_${index}" value="0" min="0" max="99"
                                           class="quantity-input" style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 5px;"
                                           onchange="validateQuantity(${index})" />
                                    <button type="button" class="btn-increase" onclick="increaseQuantity(${index})" style="background: #28a745; color: white; border: none; width: 30px; height: 30px; border-radius: 5px; margin-left: 10px;">+</button>
                                </div>
                            </div>
                        `;
                    });
                    $('#menuContainer').html(menuHtml);
                } else {
                    $('#menuContainer').html('<p>Không có món ăn nào trong khu vực này</p>');
                    console.error('Error:', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error loading menu:', error);
                $('#menuContainer').html('<p>Lỗi khi tải danh sách món ăn</p>');
            }
        });
    }

    // Hàm tăng số lượng
    function increaseQuantity(index) {
        var input = document.getElementById('quantity_' + index);
        var currentValue = parseInt(input.value) || 0;
        if (currentValue < 99) {
            input.value = currentValue + 1;
        }
    }

    // Hàm giảm số lượng
    function decreaseQuantity(index) {
        var input = document.getElementById('quantity_' + index);
        var currentValue = parseInt(input.value) || 0;
        if (currentValue > 0) {
            input.value = currentValue - 1;
        }
    }

    // Hàm validate số lượng
    function validateQuantity(index) {
        var input = document.getElementById('quantity_' + index);
        var value = parseInt(input.value) || 0;
        if (value < 0) {
            input.value = 0;
        } else if (value > 99) {
            input.value = 99;
        }
    }

    // Hàm cập nhật selectedDishesContainer trước khi submit
    function updateSelectedDishesContainer() {
        var container = $('#selectedDishesContainer');
        container.empty();

        $.each(currentDishes, function(index, dish) {
            var quantity = parseInt($('#quantity_' + index).val()) || 0;

            // Tạo các input hidden cho mỗi món ăn (kể cả quantity = 0)
            container.append(`
                <input type="hidden" name="SelectedDishes[${index}].DishId" value="${dish.dishId}" />
                <input type="hidden" name="SelectedDishes[${index}].DishName" value="${dish.dishName}" />
                <input type="hidden" name="SelectedDishes[${index}].Price" value="${dish.price}" />
                <input type="hidden" name="SelectedDishes[${index}].Quantity" value="${quantity}" />
            `);
        });

        console.log('Updated selectedDishesContainer with', currentDishes.length, 'dishes');
    }
</script>

<style>
    .table-item:hover {
        background-color: #f8f9fa;
    }

    .dish-item:hover {
        background-color: #f8f9fa;
    }

    .btn-decrease:hover, .btn-increase:hover {
        opacity: 0.8;
    }

    .quantity-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0,123,255,0.3);
    }
</style>